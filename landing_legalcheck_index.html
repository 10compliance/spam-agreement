<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ëœë”©í˜ì´ì§€ ë²•ë¥ ê²€ìˆ˜ ë„êµ¬ (ë‹¨ì¼í˜ì´ì§€ + Worker í”„ë¡ì‹œ)</title>
  <style>
    body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial;background:#f6f7fb;margin:0;padding:0;color:#222;}
    .container {max-width:980px;margin:40px auto;padding:0 18px;}
    .card {background:#fff;border-radius:18px;box-shadow:0 6px 20px rgba(0,0,0,0.06);padding:22px 24px;margin-bottom:16px;}
    h1 {margin:0;font-size:20px;}
    .sub {color:#666;font-size:13px;margin-top:6px;line-height:1.6;}
    .row {display:flex;gap:12px;flex-wrap:wrap;margin-top:16px;}
    label.small {font-size:12px;color:#777;display:block;margin-bottom:6px;}
    input[type=text], textarea, select {width:100%;padding:14px 14px;font-size:14px;border:1px solid #ddd;border-radius:12px;box-sizing:border-box;}
    textarea {min-height:140px;resize:vertical;line-height:1.55;}
    .btn {display:inline-block;padding:12px 18px;border:none;border-radius:12px;background:#111;color:#fff;font-weight:900;cursor:pointer;font-size:14px;}
    .btn:disabled {background:#777;cursor:not-allowed;}
    .btn-ghost {background:#fff;color:#111;border:1px solid #ddd;}
    .small {font-size:12px;color:#777;}
    .pill {font-size:12px;background:#111;color:#fff;padding:6px 10px;border-radius:999px;display:inline-block;margin-right:6px;}
    .resultbox {background:#0b1020;color:#e8e8e8;border-radius:16px;padding:16px;font-size:12px;line-height:1.55;white-space:pre-wrap;max-height:180px;overflow:auto;}
    .grid {display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width: 900px){ .grid {grid-template-columns:1fr;} }

    .report-wrap {background:#fff;border-radius:18px;box-shadow:0 6px 20px rgba(0,0,0,0.06);padding:0;margin-bottom:16px;overflow:hidden;}
    .report-head {padding:20px 22px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .score {font-size:34px;font-weight:900;}
    .report-body {padding:20px 22px;}
    .badge {display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;color:#fff;margin-right:10px;}
    .badge-critical {background:#d11a2a;}
    .badge-high {background:#ff5a00;}
    .badge-medium {background:#f0ad00;}
    .badge-low {background:#1a73e8;}
    .finding {display:flex;gap:12px;padding:12px;border-radius:12px;background:#fafafa;border:1px solid #eee;margin-bottom:10px;}
    .finding-title {font-weight:900;margin-bottom:6px;}
    .finding-desc {font-size:13px;color:#444;line-height:1.55;}
    .finding-meta {font-size:12px;color:#777;margin-top:6px;}
    .ok-box {padding:12px;border-radius:12px;background:#f0fff4;border:1px solid #b7ebc6;}
    .muted {color:#777;font-size:13px;}
    details {border:1px solid #eee;border-radius:14px;overflow:hidden;background:#fff;margin-top:10px;}
    summary {padding:14px 16px;cursor:pointer;font-weight:900;list-style:none;display:flex;justify-content:space-between;align-items:center;}
    summary::-webkit-details-marker {display:none;}
    pre {margin:0;padding:14px 16px;background:#0b1020;color:#e6e6e6;font-size:12px;line-height:1.55;overflow:auto;white-space:pre-wrap;}
    .audit-row {border:1px solid #eee;background:#fafafa;border-radius:14px;padding:12px;margin-bottom:10px;}
    .audit-head {display:flex;align-items:center;gap:10px;}
    .audit-body {margin-top:10px;font-size:13px;line-height:1.6;color:#333;}
    .status-pill {display:inline-block;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:900;}
    .footer {font-size:12px;color:#888;padding:16px 2px;line-height:1.55;}
    .warn {padding:12px;border-radius:12px;background:#fff7e6;border:1px solid #ffe1a3;color:#7a4b00;font-size:13px;line-height:1.55;}
  </style>
</head>

<body>
<div class="container">
  <div class="card">
    <h1>âš–ï¸ ëœë”©í˜ì´ì§€ ë²•ë¥ ê²€ìˆ˜ ë„êµ¬ (1ì•ˆ: ë‹¨ì¼í˜ì´ì§€ + Worker í”„ë¡ì‹œ)</h1>
    <div class="sub">
      âœ… URL ì…ë ¥ â†’ Workerê°€ HTML ì†ŒìŠ¤ë¥¼ ê¸ì–´ì˜´(CORS ìš°íšŒ) â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ/ë£° ê²€ìˆ˜ â†’ ê°™ì€ í˜ì´ì§€ì—ì„œ ë¦¬í¬íŠ¸ ì¶œë ¥<br>
      âœ… OCRì€ ê¸°ë³¸ ì œì™¸(í¬ê¸° ê°€ëŠ¥). í•„ìš” ì‹œ Gemini API(ì„ íƒ)ë¡œ íŒë‹¨ ë³´ê°• ê°€ëŠ¥<br>
      âœ… *ì¼ë¶€ ì‚¬ì´íŠ¸ëŠ” Cloudflare/ë´‡ì°¨ë‹¨/ë¡œê·¸ì¸ í•„ìš” ë“±ì— ì˜í•´ ì†ŒìŠ¤ ìˆ˜ì§‘ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.*
    </div>

    <div class="grid" style="margin-top:18px;">
      <div>
        <label class="small">ê²€ìˆ˜ URL</label>
        <input id="url" type="text" placeholder="https://...">
      </div>
      <div>
        <label class="small">í”„ë¡ì‹œ(Worker) URL</label>
        <input id="proxyBase" type="text" placeholder="https://xxxx.workers.dev" />
        <div class="small" style="margin-top:6px;color:#999;">
          ê¸°ë³¸ê°’ì´ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="runBtn" onclick="runCheck()">ê²€ìˆ˜ ì‹¤í–‰</button>
      <button class="btn btn-ghost" onclick="toggleAdvanced()">ê³ ê¸‰(ì¶”ì¶œ/AI ì˜µì…˜)</button>
      <span class="small" id="status"></span>
    </div>

    <div id="advanced" style="display:none; margin-top:14px;">
      <div class="card" style="box-shadow:none; border:1px solid #eee; background:#fafafa;">
        <div class="grid">
          <div>
            <label class="small">iframe srcê¹Œì§€ ìˆ˜ì§‘ ì‹œë„</label>
            <select id="fetchIframes">
              <option value="true" selected>ON (ê°€ëŠ¥í•œ ë²”ìœ„)</option>
              <option value="false">OFF</option>
            </select>
          </div>
          <div>
            <label class="small">ìˆ¨ê¹€ í…ìŠ¤íŠ¸ ì¶”ì¶œ(ìŠ¤íƒ€ì¼ ê¸°ë°˜)</label>
            <select id="extractHidden">
              <option value="true" selected>ON</option>
              <option value="false">OFF</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;" class="warn">
          <b>Gemini íŒë‹¨(ì„ íƒ)</b><br>
          - ì²´í¬í•˜ë©´ ë£° ê¸°ë°˜ ê²°ê³¼ì™€ ë³„ë„ë¡œ, Geminiì—ê²Œ â€œì¶”ê°€ ë¦¬ìŠ¤í¬ ë¬¸êµ¬/ëˆ„ë½ í•­ëª©â€ì„ íŒë³„í•˜ë„ë¡ ìš”ì²­í•©ë‹ˆë‹¤.<br>
          - API KeyëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, í˜¸ì¶œì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ ìˆ˜í–‰ë©ë‹ˆë‹¤(í‚¤ ìœ ì¶œ ì£¼ì˜).<br>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label class="small">Gemini ì‚¬ìš©</label>
            <select id="useGemini" onchange="onGeminiToggle()">
              <option value="false" selected>OFF</option>
              <option value="true">ON</option>
            </select>
          </div>
          <div>
            <label class="small">Gemini API Key</label>
            <input id="geminiKey" type="text" placeholder="AIza... (í•„ìš” ì‹œ ì…ë ¥)" disabled/>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label class="small">Gemini ëª¨ë¸</label>
          <select id="geminiModel" disabled>
            <option value="gemini-1.5-flash" selected>gemini-1.5-flash (ì¶”ì²œ)</option>
            <option value="gemini-1.5-pro">gemini-1.5-pro</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <h1 style="font-size:16px;">ê²°ê³¼(ìš”ì•½ ë¡œê·¸)</h1>
    <div class="sub">ì•„ë˜ëŠ” ìš”ì•½ ë¡œê·¸ì´ë©°, ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” ë°”ë¡œ ì•„ë˜ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
    <div class="resultbox" id="resultBox"></div>
  </div>

  <div class="report-wrap" id="reportCard" style="display:none;">
    <div class="report-head">
      <div>
        <div style="font-size:18px;font-weight:900;">ğŸ“„ ìƒì„¸ ë¦¬í¬íŠ¸</div>
        <div class="sub" id="reportMeta"></div>
      </div>
      <div style="text-align:right;">
        <div class="score" id="reportScore"></div>
        <div class="sub">(ê¸°ë³¸ì ìˆ˜ 100ì )</div>
      </div>
    </div>
    <div class="report-body">
      <div class="sub" id="reportOptions"></div>

      <div style="margin-top:14px;font-size:16px;font-weight:900;">ğŸš¨ ìœ„ë°˜/ì£¼ì˜ ì‚¬í•­ (ë£° ê¸°ë°˜)</div>
      <div id="findingsBox" style="margin-top:10px;"></div>

      <div id="geminiBoxWrap" style="display:none;">
        <div style="margin-top:18px;font-size:16px;font-weight:900;">ğŸ¤– Gemini íŒë‹¨(ë³´ê°•)</div>
        <div class="muted" style="margin:8px 0;">* ë£° ê¸°ë°˜ ê²°ê³¼ë¥¼ ëŒ€ì²´í•˜ì§€ ì•Šìœ¼ë©°, ì¶”ê°€ ë¦¬ìŠ¤í¬ íƒì§€/ëˆ„ë½ ë³´ê°•ìš©ì…ë‹ˆë‹¤.</div>
        <div id="geminiBox" class="audit-row" style="background:#f0f7ff;"></div>
      </div>

      <div style="margin-top:18px;font-size:16px;font-weight:900;">â– í•´ë‹¹ì‚¬í•­ ì—†ìŒ(N/A) í•­ëª©</div>
      <div class="muted" style="margin:8px 0;">
        * â€œN/Aâ€ëŠ” (i) í•´ë‹¹ í˜ì´ì§€ì— ì „ì œê°€ ì—†ê±°ë‚˜, (ii) í˜ì´ì§€ ìœ í˜•ìƒ ì ìš©ë˜ì§€ ì•ŠëŠ” í•­ëª©ì…ë‹ˆë‹¤. ê° í•­ëª©ë³„ë¡œ ê·¼ê±°ë¥¼ í•¨ê»˜ í‘œì‹œí•©ë‹ˆë‹¤.
      </div>
      <div id="naBox"></div>

      <div style="margin-top:18px;font-size:16px;font-weight:900;">âœ… ë£°ë³„ íŒë‹¨ ê·¼ê±°(ê°ì‚¬ ë¡œê·¸)</div>
      <details>
        <summary>ë£°ë³„ PASS/FAIL/N/A ê·¼ê±° ë³´ê¸° <span class="muted">í¼ì¹˜ê¸°</span></summary>
        <div style="padding:14px 16px;" id="auditBox"></div>
      </details>

      <div style="margin-top:18px;font-size:16px;font-weight:900;">ğŸ§¾ ì¶”ì¶œ í…ìŠ¤íŠ¸(ë””ë²„ê·¸)</div>
      <details>
        <summary>visible í…ìŠ¤íŠ¸ <span class="muted">í¼ì¹˜ê¸°</span></summary>
        <pre id="debugVisible"></pre>
      </details>
      <details>
        <summary>ìˆ¨ê¹€ í…ìŠ¤íŠ¸ <span class="muted">í¼ì¹˜ê¸°</span></summary>
        <pre id="debugHidden"></pre>
      </details>
      <details>
        <summary>iframe í…ìŠ¤íŠ¸ <span class="muted">í¼ì¹˜ê¸°</span></summary>
        <pre id="debugIframe"></pre>
      </details>

      <div class="footer">
        ë³¸ ê²€ìˆ˜ ê²°ê³¼ëŠ” ë‚´ë¶€ ì°¸ê³ ìš©ì´ë©°, ë²•ì  ì í•©ì„±ì— ëŒ€í•œ ìµœì¢… íŒë‹¨ì„ í™•ì •í•˜ê±°ë‚˜ ì´ë¥¼ ë³´ì¦í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ì‹¤ê´€ê³„ ë° ì ìš© ë²•ë ¹ì— ë”°ë¼ ê²°ë¡ ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        ë³¸ ê²°ê³¼ì— ê¸°ì´ˆí•œ ì¡°ì¹˜Â·ì˜ì‚¬ê²°ì •ì— ê´€í•œ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìœ¼ë©°, í•„ìš”í•œ ê²½ìš° ë°”ë¥¸ì‚¬ì—…ê¸°íšíŒ€ì— ë³„ë„ ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <div class="small" style="padding:10px 4px;color:#999;line-height:1.6;">
    ë³¸ ê²€ìˆ˜ ì‹œìŠ¤í…œì€ ì´ë²¤íŠ¸ í˜ì´ì§€ì˜ ë²•ì  ë¦¬ìŠ¤í¬ ì‹ë³„ì„ ìœ„í•œ <b>ë‚´ë¶€ ì°¸ê³ ìš© ë³´ì¡° ë„êµ¬</b>ì…ë‹ˆë‹¤.
  </div>
</div>

<script>
/* =========================================================
   0) ê¸°ë³¸ ì„¤ì •: í”„ë¡œë‹˜ worker URL ê¸°ë³¸ê°’ ë°•ê¸°
========================================================= */
const PROXY_BASE_DEFAULT = "https://landing-proxy.10compliance.workers.dev";

/* =========================================================
   1) UI
========================================================= */
function toggleAdvanced(){
  const el = document.getElementById("advanced");
  el.style.display = (el.style.display === "none" ? "block" : "none");
}

function onGeminiToggle(){
  const on = document.getElementById("useGemini").value === "true";
  document.getElementById("geminiKey").disabled = !on;
  document.getElementById("geminiModel").disabled = !on;
}

(function init(){
  document.getElementById("proxyBase").value = PROXY_BASE_DEFAULT;
})();

/* =========================================================
   2) Workerë¡œ HTML ê°€ì ¸ì˜¤ê¸°
========================================================= */
async function fetchHtmlViaProxy(proxyBase, url){
  const endpoint = proxyBase.replace(/\/$/, "") + "/fetch?url=" + encodeURIComponent(url);
  const resp = await fetch(endpoint, { method:"GET" });
  const text = await resp.text();
  const finalUrl = resp.headers.get("X-Proxy-Final-URL") || url;
  const proxyStatus = resp.headers.get("X-Proxy-Status") || String(resp.status);
  return { html: text, finalUrl, proxyStatus };
}

/* =========================================================
   3) HTML íŒŒì‹± + í…ìŠ¤íŠ¸ ì¶”ì¶œ (visible/hidden)
========================================================= */
function parseHtmlToDoc(html, baseUrl){
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  let baseEl = doc.querySelector("base");
  if(!baseEl){
    baseEl = doc.createElement("base");
    baseEl.href = baseUrl;
    doc.head.appendChild(baseEl);
  } else {
    baseEl.href = baseUrl;
  }
  return doc;
}

function collectTextFromDoc(doc, {extractHidden=true}){
  doc.querySelectorAll("script, style, noscript").forEach(n => n.remove());

  const visibleParts = [];
  const hiddenParts = [];

  const isHiddenByAttr = (el) => {
    if(!el) return false;
    if(el.hidden) return true;
    const aria = el.getAttribute && el.getAttribute("aria-hidden");
    if(aria === "true") return true;
    return false;
  };

  const isHiddenByStyle = (el) => {
    if(!el || !el.getAttribute) return false;
    const style = (el.getAttribute("style") || "").toLowerCase();
    if(!style) return false;
    if(style.includes("display:none")) return true;
    if(style.includes("visibility:hidden")) return true;
    if(style.includes("opacity:0")) return true;
    return false;
  };

  const walker = doc.createTreeWalker(doc.body || doc, NodeFilter.SHOW_ELEMENT, null);
  let node = walker.currentNode;

  while(node){
    const tag = (node.tagName || "").toLowerCase();
    if(tag === "input"){
      const v = node.getAttribute("value") || "";
      if(v.trim()) visibleParts.push(v.trim());
    }
    if(tag === "textarea"){
      const v = node.textContent || "";
      if(v.trim()) visibleParts.push(v.trim());
    }

    const text = (node.innerText || node.textContent || "").trim();
    if(text && text.length >= 2){
      const hidden = isHiddenByAttr(node) || (extractHidden && isHiddenByStyle(node));
      if(hidden) hiddenParts.push(text);
      else visibleParts.push(text);
    }
    node = walker.nextNode();
  }

  const uniq = (arr) => Array.from(new Set(arr.map(x => x.replace(/\s+/g," ").trim()).filter(Boolean)));
  return {
    visibleText: uniq(visibleParts).join("\n"),
    hiddenText: uniq(hiddenParts).join("\n")
  };
}

function extractIframeSrcs(doc, baseUrl){
  const srcs = [];
  doc.querySelectorAll("iframe").forEach(f => {
    const src = f.getAttribute("src");
    if(src){
      try {
        const u = new URL(src, baseUrl).toString();
        srcs.push(u);
      } catch(e){}
    }
  });
  return Array.from(new Set(srcs));
}

/* =========================================================
   4) í˜ì´ì§€ ìœ í˜• ë¶„ë¥˜(íœ´ë¦¬ìŠ¤í‹±)
========================================================= */
const PAGE_TYPES = {
  OUTBOUND_EVENT: [/ì•„ì›ƒë°”ìš´ë“œ/i,/ì „í™”\s*ìƒë‹´/i,/ìƒë‹´\s*ì „í™”/i,/TM/i,/ì½œ/i,/ì½œë°±/i,/ì—°ë½\s*ë“œë¦¬/i,/ë¬´ë£Œ\s*ìƒë‹´/i,/ë³´í—˜\s*ìƒë‹´/i,/ìƒë‹´\s*ì‹ ì²­/i,/DB/i,/ë¦¬ë“œ/i],
  EVENT: [/ì´ë²¤íŠ¸/i,/ê²½í’ˆ/i,/ì¶”ì²¨/i,/ë‹¹ì²¨/i,/ì¿ í°/i,/ì°¸ì—¬/i,/í˜œíƒ/i],
  INSURANCE: [/ë³´í—˜/i,/ì„¤ê³„ì‚¬/i,/ë³´ì¥/i,/ê°€ì…/i,/ë³´í—˜ë£Œ/i,/ì†í•´ë³´í—˜/i,/ìƒëª…ë³´í—˜/i],
  ECOMMERCE: [/ê²°ì œ/i,/ì£¼ë¬¸/i,/ë°°ì†¡/i,/ì¥ë°”êµ¬ë‹ˆ/i,/í™˜ë¶ˆ/i,/êµí™˜/i,/ìƒí’ˆ/i],
  FORM_ONLY: [/ì´ë¦„/i,/ì—°ë½ì²˜/i,/íœ´ëŒ€í°/i,/ë¬¸ì/i,/ìƒë‹´/i,/ì‹ ì²­/i,/ì œì¶œ/i,/ë¬¸ì˜/i],
};

function classifyPageType(text) {
  const hits = [];
  for (const [t, pats] of Object.entries(PAGE_TYPES)) {
    for (const p of pats) {
      if (p.test(text)) { hits.push(t); break; }
    }
  }
  if (!hits.length) return {type:"GENERIC", reason:["ìœ í˜• í‚¤ì›Œë“œ ë¯¸ê²€ì¶œ â†’ GENERICë¡œ ë¶„ë¥˜"]};
  const priority = ["OUTBOUND_EVENT","EVENT","INSURANCE","ECOMMERCE","FORM_ONLY"];
  const picked = priority.find(x => hits.includes(x)) || hits[0];
  return {type:picked, reason:[`${picked} ê´€ë ¨ í‚¤ì›Œë“œ ê²€ì¶œ â†’ ${picked}ë¡œ ë¶„ë¥˜`]};
}

function detectDraw(text){ return /ì¶”ì²¨|ë‹¹ì²¨/i.test(text); }
function detectReward(text){ return /ì¿ í°|í• ì¸ì¿ í°|ê²½í’ˆ|ìƒí’ˆê¶Œ|ì¦ì •|ì‚¬ì€í’ˆ/i.test(text); }

/* =========================================================
   5) ë£° ì—”ì§„(ìƒ˜í”Œ: í•µì‹¬ ë£°)
========================================================= */
const RULES = [
  {
    id:"PIPA_MARKETING_REQUIRED",
    severity:"CRITICAL",
    title:"ê°œì¸ì •ë³´ë³´í˜¸ë²• - ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ëŠ” ì„ íƒ ë™ì˜ ì›ì¹™(í•„ìˆ˜ í‘œì‹œ ê¸ˆì§€)",
    desc:"ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ê°€ 'í•„ìˆ˜'ë¡œ ì„¤ê³„ë  ê²½ìš°, ì„œë¹„ìŠ¤ ì œê³µê³¼ ë¬´ê´€í•œ ê°œì¸ì •ë³´ ì²˜ë¦¬ë¡œ í‰ê°€ë  ìˆ˜ ìˆì–´ ë¦¬ìŠ¤í¬ê°€ í½ë‹ˆë‹¤.",
    patterns:[
      /ë§ˆì¼€íŒ…\s*ì •ë³´\s*ìˆ˜ì‹ .*í•„ìˆ˜/i,
      /ë§ˆì¼€íŒ….*ìˆ˜ì‹ .*ë™ì˜.*í•„ìˆ˜/i,
      /ë§ˆì¼€íŒ…\s*ì •ë³´.*ë™ì˜.*í•„ìˆ˜/i,
      /ê´‘ê³ \s*ì„±\s*ì •ë³´.*í•„ìˆ˜/i,
      /ìˆ˜ì‹ \s*ë™ì˜.*í•„ìˆ˜/i,
    ],
    penalty:20,
    meta:{ applicability:"ALWAYS", na_reason:null }
  },
  {
    id:"CONSENT_FREE_WILL",
    severity:"NOTICE",
    title:"ë™ì˜ ììœ  ì›ì¹™(ì ê²€) - ë¶ˆì´ìµ ê³ ì§€ ë²”ìœ„ ì˜¤ì¸ ê°€ëŠ¥ì„±",
    desc:"â€˜ë™ì˜í•˜ì§€ ì•Šìœ¼ë©´ ì´ìš©/ì°¸ì—¬ ë¶ˆê°€â€™ ë¬¸êµ¬ê°€ ì„ íƒë™ì˜(ë§ˆì¼€íŒ…/ì œ3ì ì œê³µ ë“±)ê¹Œì§€ í¬í•¨í•˜ëŠ” ê²ƒìœ¼ë¡œ ì½íˆì§€ ì•ŠëŠ”ì§€ ì ê²€ í•„ìš”.",
    patterns:[
      /ë™ì˜í•˜ì§€\s*ì•Šì„\s*ê²½ìš°.*(ë¶ˆê°€ëŠ¥|ì œí•œ|ì°¸ì—¬\s*ë¶ˆê°€)/i,
      /ë™ì˜\s*ê±°ë¶€.*(ë¶ˆê°€ëŠ¥|ì œí•œ|ì°¸ì—¬\s*ë¶ˆê°€)/i,
      /ë¯¸ë™ì˜\s*ì‹œ.*(ë¶ˆê°€ëŠ¥|ì œí•œ|ì°¸ì—¬\s*ë¶ˆê°€)/i
    ],
    penalty:0,
    meta:{ applicability:"ALWAYS", na_reason:null }
  },
  {
    id:"PRIZE_DRAW_INFO",
    severity:"MEDIUM",
    title:"ê²½í’ˆ/ì¶”ì²¨ ê³ ì§€ - ì¶”ì²¨ì¼/ë°œí‘œ ë°©ì‹ ì•ˆë‚´ ë¶€ì¡±",
    desc:"ì¶”ì²¨í˜• ê²½í’ˆì´ ì–¸ê¸‰ë˜ë‚˜ ì¶”ì²¨ì¼/ë°œí‘œ ë°©ì‹(ë‹¹ì²¨ì ê³µì§€ ë“±) ì•ˆë‚´ê°€ ë¶€ì¡±í•˜ë©´ ë¶„ìŸÂ·ë¯¼ì› ë¦¬ìŠ¤í¬ê°€ ìˆìŠµë‹ˆë‹¤.",
    patterns:[/ë‹¹ì²¨ì\s*ë°œí‘œì¼/i, /ë°œí‘œì¼/i, /ë‹¹ì²¨ì\s*ë°œí‘œ/i, /ê³µì§€/i, /ì¶”ì²¨ì¼/i],
    penalty:10,
    meta:{ applicability:"REQUIRES_PRIZE_DRAW", na_reason:"ì¶”ì²¨(ê²½í’ˆ) ìš”ì†Œê°€ ì—†ëŠ” í˜ì´ì§€ì—ì„œëŠ” ë¹„ì ìš©" }
  },
  {
    id:"REWARD_CONDITION_DISCLOSURE",
    severity:"MEDIUM",
    title:"ê²½í’ˆ/ì¿ í° - ì§€ê¸‰ì¡°ê±´Â·ì œí•œì¡°ê±´ ê³ ì§€ í•„ìš”",
    desc:"ê²½í’ˆ/ì¿ í° ì œê³µì´ ìˆëŠ” ê²½ìš°, ì§€ê¸‰ ì¡°ê±´/1ì¸ 1íšŒ ì œí•œ/ë°œì†¡ ì‹œì /ì‚¬ìš©ê¸°í•œ ë“± ì œí•œì¡°ê±´ì´ í™•ì¸ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.",
    patterns:[/ìœ ì˜ì‚¬í•­/i, /ì£¼ì˜ì‚¬í•­/i, /ì§€ê¸‰\s*ì¡°ê±´/i, /ì‚¬ìš©ê¸°ê°„/i, /ë°œì†¡/i, /ì œí•œ/i, /1ì¸\s*1íšŒ/i],
    penalty:10,
    meta:{ applicability:"REQUIRES_REWARD", na_reason:"ì¿ í°/ê²½í’ˆ/ì¦ì • ìš”ì†Œê°€ ì—†ëŠ” í˜ì´ì§€ì—ì„œëŠ” ë¹„ì ìš©" }
  }
];

function applicability(rule, allText, pageType){
  const app = rule.meta?.applicability || "ALWAYS";
  const naReason = rule.meta?.na_reason || "";
  if (app === "ALWAYS") return {ok:true, reason:"", evidence:""};

  if (app === "REQUIRES_PRIZE_DRAW") {
    if (detectDraw(allText)) return {ok:true, reason:"", evidence:""};
    return {ok:false, reason:naReason || "ì¶”ì²¨ ìš”ì†Œ ë¯¸ê²€ì¶œ", evidence:"ê·¼ê±°: 'ì¶”ì²¨/ë‹¹ì²¨' í‚¤ì›Œë“œ ë¯¸ê²€ì¶œ"};
  }

  if (app === "REQUIRES_REWARD") {
    if (detectReward(allText)) return {ok:true, reason:"", evidence:""};
    return {ok:false, reason:naReason || "ì¿ í°/ê²½í’ˆ ìš”ì†Œ ë¯¸ê²€ì¶œ", evidence:"ê·¼ê±°: 'ì¿ í°/ê²½í’ˆ/ìƒí’ˆê¶Œ/ì¦ì •/ì‚¬ì€í’ˆ' í‚¤ì›Œë“œ ë¯¸ê²€ì¶œ"};
  }

  return {ok:true, reason:"", evidence:""};
}

function findSnippet(text, regexArr, maxLen=180){
  if(!text) return "";
  for(const r of regexArr){
    const idx = text.search(r);
    if(idx >= 0){
      const start = Math.max(idx - 70, 0);
      const end = Math.min(idx + 140, text.length);
      let snip = text.substring(start, end).replace(/\n/g," ").replace(/\s{2,}/g," ").trim();
      if(snip.length > maxLen) snip = snip.slice(0, maxLen) + "...";
      return snip;
    }
  }
  return "";
}

function runRules(allText, pageType){
  let score = 100;
  const findings = [];
  const ruleAudit = [];
  const naItems = [];

  for(const rule of RULES){
    const app = applicability(rule, allText, pageType);
    if(!app.ok){
      naItems.push({ title: rule.title, reason: `${app.reason} (í˜ì´ì§€ìœ í˜•=${pageType})`, evidence: app.evidence });
      ruleAudit.push({ severity: rule.severity, title: rule.title, status: "N/A",
        reason: `${app.reason} (í˜ì´ì§€ìœ í˜•=${pageType})`, snippet: app.evidence });
      continue;
    }

    const matched = rule.patterns.some(r => r.test(allText));
    let status = "PASS";
    let reason = "";
    let snippet = findSnippet(allText, rule.patterns);

    if(rule.id === "PIPA_MARKETING_REQUIRED"){
      if(matched){
        score -= rule.penalty;
        status = "FAIL";
        reason = "ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ê°€ â€˜í•„ìˆ˜â€™ë¡œ í‘œì‹œë¨ â†’ CRITICAL ìœ„ë°˜";
        findings.push({ severity: rule.severity, title: rule.title, desc: rule.desc, keyword: "ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜(í•„ìˆ˜)", source: "í˜ì´ì§€ ì†ŒìŠ¤" });
      } else {
        reason = "ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ â€˜í•„ìˆ˜â€™ í‘œì‹œ ë¯¸ê²€ì¶œ";
      }
    } else if(rule.id === "CONSENT_FREE_WILL"){
      if(matched){
        status = "NOTICE";
        reason = "ë¶ˆì´ìµ ì•ˆë‚´ ë¬¸êµ¬ í™•ì¸ë¨. ì„ íƒë™ì˜ê¹Œì§€ í¬í•¨ë˜ëŠ” ê²ƒìœ¼ë¡œ ì˜¤ì¸ë˜ì§€ ì•ŠëŠ”ì§€ ì ê²€ í•„ìš”(ê°ì  ì—†ìŒ).";
      } else {
        reason = "ë¶ˆì´ìµ ì•ˆë‚´ ë¬¸êµ¬ ë¯¸ê²€ì¶œ";
      }
    } else {
      if(matched){
        status = "PASS";
        reason = "ê´€ë ¨ ê³ ì§€/ìš”ê±´ ë¬¸êµ¬ê°€ í™•ì¸ë¨";
      } else {
        status = "FAIL";
        reason = "ì ìš© ì „ì œê°€ ìˆëŠ” í•­ëª©ì´ë‚˜ ê´€ë ¨ ê³ ì§€/ìš”ê±´ ë¬¸êµ¬ê°€ í™•ì¸ë˜ì§€ ì•ŠìŒ â†’ ê°ì ";
        score -= rule.penalty;
        findings.push({ severity: rule.severity, title: rule.title, desc: rule.desc, keyword: "ê³ ì§€/ìš”ê±´ ëˆ„ë½", source: "í˜ì´ì§€ ì†ŒìŠ¤" });
      }
    }

    ruleAudit.push({ severity: rule.severity, title: rule.title, status, reason, snippet: snippet || (matched ? "(ìŠ¤ë‹ˆí« ìƒì„± ì‹¤íŒ¨)" : "ê´€ë ¨ í‚¤ì›Œë“œ ë¯¸ê²€ì¶œ") });
  }

  return { score: Math.max(0, score), findings, ruleAudit, naItems };
}

/* =========================================================
   6) Gemini íŒë‹¨(ì„ íƒ)
========================================================= */
async function callGemini({apiKey, model, text, pageType}){
  const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
  const prompt = `
ë„ˆëŠ” í•œêµ­ ë²•ë¥ (ê°œì¸ì •ë³´ë³´í˜¸ë²•, ì •ë³´í†µì‹ ë§ë²• ê´‘ê³ ì„± ì •ë³´, í‘œì‹œê´‘ê³ ë²•/ê²½í’ˆê³ ì‹œ) ê´€ì ì—ì„œ ëœë”©í˜ì´ì§€ ë¬¸êµ¬ë¥¼ ì ê²€í•˜ëŠ” ë²•ë¬´ ê²€í†  ë„ìš°ë¯¸ë‹¤.
ì•„ë˜ëŠ” ëœë”©í˜ì´ì§€ì—ì„œ ì¶”ì¶œí•œ í…ìŠ¤íŠ¸ë‹¤. í˜ì´ì§€ ìœ í˜•ì€ ${pageType}ì´ë‹¤.

[ìš”ì²­]
1) ë²•ë¥ /ê·œì œ ë¦¬ìŠ¤í¬ê°€ ìˆëŠ” ë¬¸êµ¬(ì˜¤ì¸ ê°€ëŠ¥ í¬í•¨)ë¥¼ ìµœëŒ€ 8ê°œê¹Œì§€ ì°¾ì•„ì„œ, ê° í•­ëª©ë³„ë¡œ:
   - ë¦¬ìŠ¤í¬ ìœ í˜•
   - ë¬¸ì œ ë¬¸êµ¬(ì›ë¬¸ ê·¸ëŒ€ë¡œ)
   - ì™œ ë¬¸ì œì¸ì§€
   - ê°œì„  ê¶Œê³  ë¬¸êµ¬(ì‹¤ë¬´í˜•)
2) ëˆ„ë½ ê°€ëŠ¥ì„±ì´ í° í•„ìˆ˜ ê³ ì§€ í•­ëª©ì„ ìµœëŒ€ 6ê°œê¹Œì§€ ì œì‹œ
3) ë§ˆì§€ë§‰ì— "ì¢…í•© ë¦¬ìŠ¤í¬ ë“±ê¸‰(LOW/MEDIUM/HIGH/CRITICAL)"ì„ í•œ ì¤„ë¡œ ì œì‹œ

[í…ìŠ¤íŠ¸]
${text}
  `.trim();

  const body = {
    contents: [{ role:"user", parts:[{ text: prompt }]}],
    generationConfig: { temperature: 0.2, maxOutputTokens: 1024 }
  };

  const resp = await fetch(endpoint, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!resp.ok){
    const err = await resp.text();
    throw new Error("Gemini í˜¸ì¶œ ì‹¤íŒ¨: " + err.slice(0,400));
  }
  const data = await resp.json();
  const out = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join("\n") || "";
  return out.trim();
}

/* =========================================================
   7) ë¦¬í¬íŠ¸ ë Œë”
========================================================= */
function sevClass(sev){
  if(sev==="CRITICAL") return "badge-critical";
  if(sev==="HIGH") return "badge-high";
  if(sev==="MEDIUM") return "badge-medium";
  return "badge-low";
}
function statusPill(status){
  const m = {
    "PASS": ["PASS","#1e8e3e"],
    "FAIL": ["FAIL","#d11a2a"],
    "N/A": ["N/A","#777"],
    "NOTICE": ["NOTICE","#1a73e8"]
  };
  const [label, color] = m[status] || ["N/A","#777"];
  return `<span class="status-pill" style="background:${color}">${label}</span>`;
}
function escapeHtml(s){
  if(s==null) return "";
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderReport({url, finalUrl, proxyStatus, pageType, typeReason, score, findings, ruleAudit, naItems, visibleText, hiddenText, iframeText, options}) {
  document.getElementById("reportScore").innerText = `${score}ì `;
  document.getElementById("reportMeta").innerHTML = `
    ê²€ìˆ˜ ëŒ€ìƒ: <a href="${escapeHtml(finalUrl)}" target="_blank"><b>${escapeHtml(finalUrl)}</b></a><br/>
    í”„ë¡ì‹œ ìƒíƒœ: <b>${escapeHtml(proxyStatus)}</b><br/>
    ìƒì„±: <b>${new Date().toLocaleString()}</b><br/>
    í˜ì´ì§€ ìœ í˜•: <b>${pageType}</b> <span class="muted">(${escapeHtml(typeReason.join(" / "))})</span>
  `;
  document.getElementById("reportOptions").innerHTML = `
    ì˜µì…˜:
    <span class="pill">iframe=${String(options.fetchIframes)}</span>
    <span class="pill">ìˆ¨ê¹€ì¶”ì¶œ=${String(options.extractHidden)}</span>
    <span class="pill">Gemini=${String(options.useGemini)}</span>
  `;

  const fBox = document.getElementById("findingsBox");
  if(!findings.length){
    fBox.innerHTML = `<div class="ok-box">âœ… ì£¼ìš” ìœ„ë°˜/ì£¼ì˜ ì‚¬í•­ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>`;
  } else {
    fBox.innerHTML = findings.map(f => `
      <div class="finding">
        <span class="badge ${sevClass(f.severity)}">${escapeHtml(f.severity)}</span>
        <div>
          <div class="finding-title">${escapeHtml(f.title)}</div>
          <div class="finding-desc">${escapeHtml(f.desc)}</div>
          <div class="finding-meta">í‚¤ì›Œë“œ: <b>${escapeHtml(f.keyword)}</b> / ê¸°ì¤€: ${escapeHtml(f.source)}</div>
        </div>
      </div>
    `).join("");
  }

  const naBox = document.getElementById("naBox");
  if(!naItems.length){
    naBox.innerHTML = `<div class="muted">ì—†ìŒ</div>`;
  } else {
    naBox.innerHTML = naItems.map(n => `
      <div class="audit-row" style="background:#f7f7f7;">
        <div style="font-weight:900;">â– ${escapeHtml(n.title)}</div>
        <div class="muted" style="margin-top:6px;">${escapeHtml(n.reason)}</div>
        <div class="muted" style="margin-top:6px;"><b>ê·¼ê±°:</b> ${escapeHtml(n.evidence || "í•´ë‹¹ ì—†ìŒ")}</div>
      </div>
    `).join("");
  }

  const aBox = document.getElementById("auditBox");
  aBox.innerHTML = ruleAudit.map(a => `
    <div class="audit-row">
      <div class="audit-head">
        ${statusPill(a.status)}
        <span style="font-weight:900;">${escapeHtml(a.title)}</span>
        <span class="badge ${sevClass(a.severity)}" style="margin-left:auto;">${escapeHtml(a.severity)}</span>
      </div>
      <div class="audit-body">
        <div><b>íŒë‹¨ ì‚¬ìœ :</b> ${escapeHtml(a.reason)}</div>
        <div style="margin-top:8px;"><b>ê·¼ê±° ë¬¸êµ¬/ì‚¬ìœ :</b> <span class="muted">${escapeHtml(a.snippet)}</span></div>
      </div>
    </div>
  `).join("");

  document.getElementById("debugVisible").innerText = visibleText || "";
  document.getElementById("debugHidden").innerText = hiddenText || "";
  document.getElementById("debugIframe").innerText = iframeText || "";
}

/* =========================================================
   8) ì‹¤í–‰
========================================================= */
async function runCheck(){
  const url = document.getElementById("url").value.trim();
  const proxyBase = document.getElementById("proxyBase").value.trim();
  const fetchIframes = document.getElementById("fetchIframes").value === "true";
  const extractHidden = document.getElementById("extractHidden").value === "true";
  const useGemini = document.getElementById("useGemini").value === "true";
  const geminiKey = document.getElementById("geminiKey").value.trim();
  const geminiModel = document.getElementById("geminiModel").value;

  if(!url){ alert("URLì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  if(!proxyBase){ alert("í”„ë¡ì‹œ(Worker) URLì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
  if(useGemini && !geminiKey){ alert("Gemini ONì´ë©´ API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }

  document.getElementById("runBtn").disabled = true;
  document.getElementById("status").innerText = "ê²€ìˆ˜ ì¤‘... (HTML ìˆ˜ì§‘/ë¶„ì„)";
  document.getElementById("geminiBoxWrap").style.display = "none";
  document.getElementById("geminiBox").innerHTML = "";

  try {
    const main = await fetchHtmlViaProxy(proxyBase, url);
    const doc = parseHtmlToDoc(main.html, main.finalUrl);
    const texts = collectTextFromDoc(doc, { extractHidden });

    let iframeText = "";
    let iframeCount = 0;

    if(fetchIframes){
      const iframeSrcs = extractIframeSrcs(doc, main.finalUrl);
      iframeCount = iframeSrcs.length;
      if(iframeSrcs.length){
        document.getElementById("status").innerText = `ê²€ìˆ˜ ì¤‘... (iframe ${iframeSrcs.length}ê°œ ìˆ˜ì§‘ ì‹œë„)`;
      }
      for(const src of iframeSrcs){
        try{
          const f = await fetchHtmlViaProxy(proxyBase, src);
          const fdoc = parseHtmlToDoc(f.html, f.finalUrl);
          const ftexts = collectTextFromDoc(fdoc, { extractHidden:false });
          iframeText += "\n\n[IFRAME] " + f.finalUrl + "\n" + (ftexts.visibleText || "");
        }catch(e){
          iframeText += "\n\n[IFRAME-FAIL] " + src + "\n" + String(e.message || e);
        }
      }
    }

    const allText = [texts.visibleText, texts.hiddenText, iframeText].filter(Boolean).join("\n\n");
    const typeInfo = classifyPageType(allText);
    const pageType = typeInfo.type;
    const typeReason = typeInfo.reason;

    const result = runRules(allText, pageType);

    const logLines = [];
    logLines.push(`ê²€ìˆ˜ ëŒ€ìƒ: ${url}`);
    logLines.push(`ìµœì¢… URL: ${main.finalUrl}`);
    logLines.push(`í”„ë¡ì‹œ ìƒíƒœ: ${main.proxyStatus}`);
    logLines.push(`ì˜µì…˜: iframe=${fetchIframes}, ìˆ¨ê¹€ì¶”ì¶œ=${extractHidden}, Gemini=${useGemini}`);
    logLines.push(`iframe ìˆ˜: ${iframeCount}`);
    logLines.push(`í˜ì´ì§€ ìœ í˜•: ${pageType} / ê·¼ê±°=${typeReason.join(" / ")}`);
    logLines.push("--------------------------------------------------");
    logLines.push(`ìµœì¢… ì ìˆ˜: ${result.score}ì `);
    if(result.findings.length){
      logLines.push("ìœ„ë°˜/ì£¼ì˜ ì‚¬í•­:");
      for(const f of result.findings){
        logLines.push(` - [${f.severity}] ${f.title} (í‚¤ì›Œë“œ: ${f.keyword})`);
      }
    } else {
      logLines.push("ìœ„ë°˜/ì£¼ì˜ ì‚¬í•­: ì—†ìŒ");
    }
    if(result.naItems.length){
      logLines.push("");
      logLines.push("N/A í•­ëª©(ê·¼ê±° í¬í•¨):");
      for(const n of result.naItems){
        logLines.push(` - â– ${n.title} / ${n.reason}`);
      }
    }

    document.getElementById("resultCard").style.display = "block";
    document.getElementById("resultBox").innerText = logLines.join("\n");

    document.getElementById("reportCard").style.display = "block";
    renderReport({
      url,
      finalUrl: main.finalUrl,
      proxyStatus: main.proxyStatus,
      pageType,
      typeReason,
      score: result.score,
      findings: result.findings,
      ruleAudit: result.ruleAudit,
      naItems: result.naItems,
      visibleText: texts.visibleText,
      hiddenText: texts.hiddenText,
      iframeText,
      options:{ fetchIframes, extractHidden, useGemini }
    });

    if(useGemini){
      document.getElementById("status").innerText = "Gemini íŒë‹¨ ì¤‘...";
      const geminiOut = await callGemini({
        apiKey: geminiKey,
        model: geminiModel,
        text: allText.slice(0, 24000),
        pageType
      });
      document.getElementById("geminiBoxWrap").style.display = "block";
      document.getElementById("geminiBox").innerHTML = `<div style="white-space:pre-wrap;line-height:1.6;">${escapeHtml(geminiOut)}</div>`;
    }

  } catch(e) {
    alert("ì˜¤ë¥˜: " + (e.message || e));
  }

  document.getElementById("runBtn").disabled = false;
  document.getElementById("status").innerText = "";
}
</script>
</body>
</html>
